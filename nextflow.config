/*
 * Configuration file for TAPIR + PopPUNK + Per-Clade SNP Analysis Pipeline
 * Optimized for local execution with Docker on Intel Core Ultra 9 185H (22 threads, 64GB RAM)
 */

// Default parameters
params {
    // Input/Output
    input      = './assemblies'         // directory containing FASTA assemblies
    resultsDir = './results'            // output directory
    help       = false                  // show help message
    
    // Resource allocation optimized for 400 files
    poppunk_threads = 22                // PopPUNK can use all threads (memory intensive)
    panaroo_threads = 16                // Panaroo moderate threading
    gubbins_threads = 8                 // Gubbins moderate threading  
    iqtree_threads = 4                  // IQ-TREE light threading (many parallel jobs)
    ram = '64 GB'                       // total system RAM
}

// Process configuration
process {
    // Default settings
    executor = 'local'
    
    // Process-specific resource allocation
    withName: POPPUNK {
        cpus = params.poppunk_threads
        memory = '48 GB'  // Most memory for clustering step
        container = 'mwanji/poppunk:2.6.2'
    }
    
    withName: PANAROO {
        cpus = params.panaroo_threads
        memory = '24 GB'  // Moderate memory per cluster
        container = 'quay.io/biocontainers/panaroo:1.7.0--pyhdfd78af_0'
    }
    
    withName: GUBBINS {
        cpus = params.gubbins_threads
        memory = '12 GB'  // Light memory per cluster
        container = 'quay.io/biocontainers/gubbins:2.4.1--py36hb206151_3'
    }
    
    withName: IQTREE {
        cpus = params.iqtree_threads
        memory = '6 GB'   // Light memory per cluster
        container = 'quay.io/biocontainers/iqtree:2.1.2--hdc80bf6_0'
    }
}

// Docker configuration
docker {
    enabled = true
    runOptions = '-u $(id -u):$(id -g)'
    temp = 'auto'
}

// Execution configuration
executor {
    name = 'local'
    cpus = 22
    memory = '64 GB'
    queueSize = 10  // Limit concurrent processes to manage memory
}

// Workflow configuration
workflow {
    workDir = './work'
}

// Reporting
report {
    enabled = true
    file = "${params.resultsDir}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.resultsDir}/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.resultsDir}/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.resultsDir}/dag.html"
    overwrite = true
}
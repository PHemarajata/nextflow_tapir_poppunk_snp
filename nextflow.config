/*
 * Configuration file for TAPIR + PopPUNK + Per-Clade SNP Analysis Pipeline
 * Optimized for local execution with Docker on Intel Core Ultra 9 185H (22 threads, 64GB RAM)
 */

// Default parameters
params {
    // Input/Output
    input      = './assemblies'         // directory containing FASTA assemblies
    resultsDir = './results'            // output directory
    help       = false                  // show help message
    
    // Resource allocation optimized for 400 files
    poppunk_threads = 22                // PopPUNK can use all threads (memory intensive)
    panaroo_threads = 16                // Panaroo moderate threading
    gubbins_threads = 8                 // Gubbins moderate threading  
    iqtree_threads = 4                  // IQ-TREE light threading (many parallel jobs)
    ram = '64 GB'                       // total system RAM
}

// Process configuration
process {
    // Default settings
    executor = 'local'
    
    // Process-specific resource allocation
    withName: POPPUNK {
        cpus = params.poppunk_threads
        memory = '48 GB'  // Most memory for clustering step
        container = 'staphb/poppunk:2.7.5'
    }
    
    withName: PANAROO {
        cpus = params.panaroo_threads
        memory = '24 GB'  // Moderate memory per cluster
        container = 'staphb/panaroo:1.5.2'
    }
    
    withName: GUBBINS {
        cpus = params.gubbins_threads
        memory = '12 GB'  // Light memory per cluster
        container = 'staphb/gubbins:3.3.5'
    }
    
    withName: IQTREE {
        cpus = params.iqtree_threads
        memory = '6 GB'   // Light memory per cluster
        container = 'staphb/iqtree2:2.4.0'
    }
}

// Docker configuration - Fixed for Ubuntu file sharing
docker {
    enabled = true
    runOptions = '-u $(id -u):$(id -g)'
    temp = 'auto'
    fixOwnership = true
    remove = true
}

// Execution configuration
executor {
    name = 'local'
    cpus = 22
    memory = '64 GB'
    queueSize = 10  // Limit concurrent processes to manage memory
}

// Workflow configuration - Use local accessible directories
workflow {
    workDir = "${PWD}/work"
}

// Environment variables for Ubuntu Docker compatibility
env {
    TMPDIR = "${PWD}/tmp"
    NXF_TEMP = "${PWD}/tmp"
}



// Reporting
report {
    enabled = true
    file = "${params.resultsDir}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.resultsDir}/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.resultsDir}/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.resultsDir}/dag.html"
    overwrite = true
}

// Profiles for different systems
profiles {
    ubuntu_docker {
        docker {
            enabled = true
            runOptions = '-u $(id -u):$(id -g)'
            temp = './tmp'
            fixOwnership = true
            remove = true
        }
        
        env {
            TMPDIR = './tmp'
            NXF_TEMP = './tmp'
        }
        
        process {
            beforeScript = 'mkdir -p ./tmp'
        }
    }
    
    local_tmp {
        docker {
            enabled = true
            runOptions = '-u $(id -u):$(id -g) -v $(pwd)/tmp:/tmp'
            temp = './tmp'
            fixOwnership = true
            remove = true
        }
        
        env {
            TMPDIR = './tmp'
            NXF_TEMP = './tmp'
        }
        
        process {
            beforeScript = 'mkdir -p ./tmp'
        }
    }
    
    standard {
        // Uses the default Docker configuration defined above
    }
}